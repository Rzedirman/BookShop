@* Areas/Seller/Views/Books/Details.cshtml *@

@model BookShop.Models.Product

@{
    ViewData["Title"] = "Book Details";
    int totalSales = (int)ViewData["TotalSales"];
    decimal totalRevenue = (decimal)ViewData["TotalRevenue"];
    DateTime? lastSoldDate = (DateTime?)ViewData["LastSoldDate"];
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Book Details</h1>
        <div>
            <a asp-action="Edit" asp-route-id="@Model.ProductId" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Edit Book
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to My Books
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Book Information -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            @if (!string.IsNullOrEmpty(Model.ImageName) && Model.ImageName != "noimage.png")
                            {
                                <img src="~/images/covers/@Model.ImageName" alt="@Model.Title" class="img-fluid rounded shadow" style="max-height: 250px;">
                            }
                            else
                            {
                                <div class="bg-light d-flex align-items-center justify-content-center rounded shadow" style="height: 250px; width: 100%;">
                                    <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
                                </div>
                            }

                            <!-- File Status -->
                            <div class="mt-3">
                                @if (!string.IsNullOrEmpty(Model.FileName))
                                {
                                    <span class="badge bg-success">
                                        <i class="bi bi-file-earmark-check"></i> File Available
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-exclamation-triangle"></i> No File
                                    </span>
                                }
                            </div>
                        </div>
                        <div class="col-md-9">
                            <h2 class="mb-3">@Model.Title</h2>
                            <p class="text-muted mb-3">
                                by <strong>@Model.Author.Name @Model.Author.LastName</strong>
                            </p>

                            <dl class="row">
                                <dt class="col-sm-3">Book ID</dt>
                                <dd class="col-sm-9">#@Model.ProductId</dd>

                                <dt class="col-sm-3">Genre</dt>
                                <dd class="col-sm-9">@Model.Genre.GenreName</dd>

                                <dt class="col-sm-3">Language</dt>
                                <dd class="col-sm-9">@Model.Language.LanguageName</dd>

                                <dt class="col-sm-3">Price</dt>
                                <dd class="col-sm-9">
                                    <span class="h4 text-success">$@Model.Price.ToString("0.00")</span>
                                </dd>

                                <dt class="col-sm-3">Stock</dt>
                                <dd class="col-sm-9">
                                    @if (Model.InStock > 0)
                                    {
                                        <span class="badge bg-success">@Model.InStock available</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Out of stock</span>
                                    }
                                </dd>

                                <dt class="col-sm-3">Publication Date</dt>
                                <dd class="col-sm-9">@Model.PublicationDate.ToString("MMMM dd, yyyy")</dd>

                                @if (lastSoldDate.HasValue)
                                {
                                    <dt class="col-sm-3">Last Sold</dt>
                                    <dd class="col-sm-9">@lastSoldDate.Value.ToString("MMMM dd, yyyy")</dd>
                                }

                                <dt class="col-sm-3">File Name</dt>
                                <dd class="col-sm-9">
                                    @if (!string.IsNullOrEmpty(Model.FileName))
                                    {
                                        <code>@Model.FileName</code>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No file uploaded</span>
                                    }
                                </dd>
                            </dl>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h5>Description</h5>
                        <div class="border-start border-primary border-3 ps-3">
                            <p class="mb-0">@Model.Description</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            @if (Model.Orders.Any())
            {
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-cart-check"></i> Recent Orders
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                        <th>Date</th>
                                        <th>Delivery</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var order in Model.Orders.OrderByDescending(o => o.OrderDate).Take(10))
                                    {
                                        <tr>
                                            <td><strong>#@order.OrderId</strong></td>
                                            <td>
                                                <div>
                                                    <strong>@order.User.Name @order.User.LastName</strong><br>
                                                    <small class="text-muted">@order.User.Email</small>
                                                </div>
                                            </td>
                                            <td>@order.Amount</td>
                                            <td class="text-success"><strong>$@order.TotalPrice.ToString("0.00")</strong></td>
                                            <td>@order.OrderDate.ToString("MM/dd/yyyy HH:mm")</td>
                                            <td>
                                                <small class="text-muted" style="max-width: 150px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                    @order.DeliveryAddress
                                                </small>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (Model.Orders.Count > 10)
                        {
                            <div class="text-center mt-3">
                                <small class="text-muted">Showing 10 of @Model.Orders.Count orders</small>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Statistics & Actions -->
        <div class="col-md-4">
            <!-- Sales Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Sales Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="row">
                            <div class="col-6">
                                <div class="card bg-success bg-opacity-10 border-success">
                                    <div class="card-body p-3">
                                        <h3 class="text-success mb-1">@totalSales</h3>
                                        <small class="text-muted">Units Sold</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-primary bg-opacity-10 border-primary">
                                    <div class="card-body p-3">
                                        <h3 class="text-primary mb-1">$@totalRevenue.ToString("0.00")</h3>
                                        <small class="text-muted">Total Revenue</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <dl class="row mb-0 small">
                        <dt class="col-6">Total Orders:</dt>
                        <dd class="col-6">@Model.Orders.Count</dd>

                        @if (totalSales > 0)
                        {
                            <dt class="col-6">Avg. Order Size:</dt>
                            <dd class="col-6">@Math.Round((decimal)totalSales / Model.Orders.Count, 1)</dd>

                            <dt class="col-6">Avg. Order Value:</dt>
                            <dd class="col-6">$@(totalRevenue / Model.Orders.Count).ToString("0.00")</dd>
                        }

                        <dt class="col-6">Remaining Stock:</dt>
                        <dd class="col-6">@Model.InStock units</dd>
                    </dl>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-action="Edit" asp-route-id="@Model.ProductId" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Edit Book
                        </a>
                        <a asp-area="Seller" asp-controller="Sales" asp-action="BookDetails" asp-route-id="@Model.ProductId" class="btn btn-outline-info">
                            <i class="bi bi-graph-up"></i> Detailed Analytics
                        </a>
                        <a asp-action="Delete" asp-route-id="@Model.ProductId" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete Book
                        </a>
                    </div>
                </div>
            </div>

            <!-- Book Status -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Book Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Availability:</strong>
                        @if (Model.InStock > 0 && !string.IsNullOrEmpty(Model.FileName))
                        {
                            <span class="badge bg-success">Active & Available</span>
                        }
                        else if (Model.InStock <= 0)
                        {
                            <span class="badge bg-warning text-dark">Out of Stock</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">No File Uploaded</span>
                        }
                    </div>

                    <div class="mb-3">
                        <strong>Files:</strong>
                        <ul class="list-unstyled mt-2">
                            <li>
                                <i class="bi bi-file-earmark-text me-2"></i>
                                Book File:
                                @if (!string.IsNullOrEmpty(Model.FileName))
                                {
                                    <span class="text-success">✓ Uploaded</span>
                                }
                                else
                                {
                                    <span class="text-danger">✗ Missing</span>
                                }
                            </li>
                            <li>
                                <i class="bi bi-image me-2"></i>
                                Cover Image:
                                @if (!string.IsNullOrEmpty(Model.ImageName) && Model.ImageName != "noimage.png")
                                {
                                    <span class="text-success">✓ Uploaded</span>
                                }
                                else
                                {
                                    <span class="text-warning">Default</span>
                                }
                            </li>
                        </ul>
                    </div>

                    @if (string.IsNullOrEmpty(Model.FileName))
                    {
                        <div class="alert alert-warning">
                            <small>
                                <i class="bi bi-exclamation-triangle"></i>
                                This book cannot be purchased without a file. Please upload a book file.
                            </small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Add Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
}