@* Areas/Seller/Views/Sales/Orders.cshtml *@

@model BookShop.Helpers.PaginatedList<BookShop.Models.Order>
@{
    ViewData["Title"] = "My Orders";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-cart-check"></i> My Orders
        </h1>
        <div>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Analytics
            </a>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Filters & Search</h5>
        </div>
        <div class="card-body">
            <form asp-action="Orders" method="get" id="filterForm">
                <div class="row">
                    <!-- Search -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Search Orders</label>
                        <input type="text" name="SearchString" value="@ViewData["CurrentFilter"]" class="form-control"
                               placeholder="Order ID, Customer, Book title..." />
                    </div>

                    <!-- Date Range -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">From Date</label>
                        <input type="date" name="StartDate" value="@ViewData["StartDate"]" class="form-control" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">To Date</label>
                        <input type="date" name="EndDate" value="@ViewData["EndDate"]" class="form-control" />
                    </div>

                    <div class="col-md-2 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <a asp-action="Orders" class="btn btn-secondary btn-sm">
                            <i class="bi bi-x-circle"></i> Clear Filters
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (Model.Any())
    {
        <!-- Summary Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary bg-opacity-10 border-primary">
                    <div class="card-body text-center">
                        <h4 class="text-primary">@Model.Count()</h4>
                        <small class="text-muted">Orders Shown</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success bg-opacity-10 border-success">
                    <div class="card-body text-center">
                        <h4 class="text-success">@Model.Sum(o => o.Amount)</h4>
                        <small class="text-muted">Books Sold</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning bg-opacity-10 border-warning">
                    <div class="card-body text-center">
                        <h4 class="text-warning">$@Model.Sum(o => o.TotalPrice).ToString("N2")</h4>
                        <small class="text-muted">Total Revenue</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info bg-opacity-10 border-info">
                    <div class="card-body text-center">
                        <h4 class="text-info">@Model.Select(o => o.UserId).Distinct().Count()</h4>
                        <small class="text-muted">Unique Customers</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <a asp-action="Orders" asp-route-sortOrder="@ViewData["OrderIdSortParam"]"
                                       asp-route-currentFilter="@ViewData["CurrentFilter"]"
                                       asp-route-startDate="@ViewData["StartDate"]"
                                       asp-route-endDate="@ViewData["EndDate"]">
                                        Order ID
                                        @if (string.IsNullOrEmpty((string)ViewData["CurrentSort"]))
                                        {
                                            <i class="bi bi-arrow-up-short"></i>
                                        }
                                        else if ((string)ViewData["CurrentSort"] == "orderid_desc")
                                        {
                                            <i class="bi bi-arrow-down-short"></i>
                                        }
                                    </a>
                                </th>
                                <th>Customer</th>
                                <th>
                                    <a asp-action="Orders" asp-route-sortOrder="@ViewData["BookSortParam"]"
                                       asp-route-currentFilter="@ViewData["CurrentFilter"]"
                                       asp-route-startDate="@ViewData["StartDate"]"
                                       asp-route-endDate="@ViewData["EndDate"]">
                                        Book
                                        @if ((string)ViewData["CurrentSort"] == "book")
                                        {
                                            <i class="bi bi-arrow-up-short"></i>
                                        }
                                        else if ((string)ViewData["CurrentSort"] == "book_desc")
                                        {
                                            <i class="bi bi-arrow-down-short"></i>
                                        }
                                    </a>
                                </th>
                                <th>Quantity</th>
                                <th>
                                    <a asp-action="Orders" asp-route-sortOrder="@ViewData["AmountSortParam"]"
                                       asp-route-currentFilter="@ViewData["CurrentFilter"]"
                                       asp-route-startDate="@ViewData["StartDate"]"
                                       asp-route-endDate="@ViewData["EndDate"]">
                                        Total
                                        @if ((string)ViewData["CurrentSort"] == "amount")
                                        {
                                            <i class="bi bi-arrow-up-short"></i>
                                        }
                                        else if ((string)ViewData["CurrentSort"] == "amount_desc")
                                        {
                                            <i class="bi bi-arrow-down-short"></i>
                                        }
                                    </a>
                                </th>
                                <th>
                                    <a asp-action="Orders" asp-route-sortOrder="@ViewData["DateSortParam"]"
                                       asp-route-currentFilter="@ViewData["CurrentFilter"]"
                                       asp-route-startDate="@ViewData["StartDate"]"
                                       asp-route-endDate="@ViewData["EndDate"]">
                                        Date
                                        @if ((string)ViewData["CurrentSort"] == "date")
                                        {
                                            <i class="bi bi-arrow-up-short"></i>
                                        }
                                        else if ((string)ViewData["CurrentSort"] == "date_desc")
                                        {
                                            <i class="bi bi-arrow-down-short"></i>
                                        }
                                    </a>
                                </th>
                                <th>Delivery</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model)
                            {
                                <tr>
                                    <td>
                                        <strong class="text-primary">#@order.OrderId</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@order.User.Name @order.User.LastName</strong><br>
                                            <small class="text-muted">@order.User.Email</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@order.Product.Title</strong><br>
                                            <small class="text-muted">ID: @order.Product.ProductId</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@order.Amount</span>
                                    </td>
                                    <td>
                                        <strong class="text-success">$@order.TotalPrice.ToString("N2")</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@order.OrderDate.ToString("MM/dd/yyyy")</strong><br>
                                            <small class="text-muted">@order.OrderDate.ToString("HH:mm")</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="max-width: 150px;">
                                            <small class="text-muted">
                                                @if (order.DeliveryAddress.Length > 30)
                                                {
                                                    @order.DeliveryAddress.Substring(0, 30) <small class="text-muted">...</small>
                                                }
                                                else
                                                {
                                                    @order.DeliveryAddress
                                                }
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a asp-action="BookDetails" asp-route-id="@order.Product.ProductId"
                                               class="btn btn-sm btn-outline-info" title="Book Analytics">
                                                <i class="bi bi-graph-up"></i>
                                            </a>
                                            <a asp-controller="Books" asp-action="Details" asp-route-id="@order.Product.ProductId"
                                               class="btn btn-sm btn-outline-primary" title="View Book">
                                                <i class="bi bi-book"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        @{
                            var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
                            var nextDisabled = !Model.HasNextPage ? "disabled" : "";
                        }
                        <li class="page-item @prevDisabled">
                            <a asp-action="Orders"
                               asp-route-sortOrder="@ViewData["CurrentSort"]"
                               asp-route-pageNumber="@(Model.PageIndex - 1)"
                               asp-route-currentFilter="@ViewData["CurrentFilter"]"
                               asp-route-startDate="@ViewData["StartDate"]"
                               asp-route-endDate="@ViewData["EndDate"]"
                               class="page-link">
                                Previous
                            </a>
                        </li>

                        @for (var i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                                <a asp-action="Orders"
                                   asp-route-sortOrder="@ViewData["CurrentSort"]"
                                   asp-route-pageNumber="@i"
                                   asp-route-currentFilter="@ViewData["CurrentFilter"]"
                                   asp-route-startDate="@ViewData["StartDate"]"
                                   asp-route-endDate="@ViewData["EndDate"]"
                                   class="page-link">
                                    @i
                                </a>
                            </li>
                        }

                        <li class="page-item @nextDisabled">
                            <a asp-action="Orders"
                               asp-route-sortOrder="@ViewData["CurrentSort"]"
                               asp-route-pageNumber="@(Model.PageIndex + 1)"
                               asp-route-currentFilter="@ViewData["CurrentFilter"]"
                               asp-route-startDate="@ViewData["StartDate"]"
                               asp-route-endDate="@ViewData["EndDate"]"
                               class="page-link">
                                Next
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
    else
    {
        <!-- No Orders Message -->
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="bi bi-cart-x display-1 text-muted"></i>
                </div>
                <h3>No Orders Found</h3>
                <p class="text-muted mb-4">
                    @if (ViewData["CurrentFilter"] != null || ViewData["StartDate"] != null)
                    {
                        <span>No orders match your current filters.</span>
                    }
                    else
                    {
                        <span>You don't have any orders yet. Start promoting your books to get sales!</span>
                    }
                </p>
                @if (ViewData["CurrentFilter"] != null || ViewData["StartDate"] != null)
                {
                    <a asp-action="Orders" class="btn btn-primary">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </a>
                }
                else
                {
                    <div>
                        <a asp-controller="Books" asp-action="Index" class="btn btn-primary me-2">
                            <i class="bi bi-book"></i> Manage Books
                        </a>
                        <a asp-controller="Books" asp-action="Create" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Add New Book
                        </a>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Export Options -->
    @if (Model.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Export Options</h5>
                        <p class="text-muted">Export your order data for external analysis</p>
                        <div class="d-flex gap-2">
                            <a href="#" class="btn btn-outline-success" onclick="exportToCSV()">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Export to CSV
                            </a>
                            <a asp-action="Reports"
                               asp-route-startDate="@ViewData["StartDate"]"
                               asp-route-endDate="@ViewData["EndDate"]"
                               class="btn btn-outline-primary">
                                <i class="bi bi-file-earmark-bar-graph"></i> Generate Detailed Report
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <!-- Add Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

    <script>
        function exportToCSV() {
            // Simple CSV export functionality
            var table = document.querySelector('.table');
            var csv = [];
            var rows = table.querySelectorAll('tr');

            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll('td, th');

                for (var j = 0; j < cols.length - 1; j++) { // Exclude actions column
                    var data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, ' ').replace(/"/g, '""');
                    row.push('"' + data + '"');
                }
                csv.push(row.join(','));
            }

            var csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
            var downloadLink = document.createElement('a');
            downloadLink.download = 'seller-orders-' + new Date().toISOString().slice(0, 10) + '.csv';
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // Auto-submit form on date change for better UX
        document.querySelectorAll('input[type="date"]').forEach(function (input) {
            input.addEventListener('change', function () {
                document.getElementById('filterForm').submit();
            });
        });
    </script>
}